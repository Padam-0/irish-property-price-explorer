{% extends 'homepage/header.html' %}

{% block content %}
    {% load staticfiles %}
    <link href="{% static 'riskdb/css/index-style.css' %}" rel="stylesheet">
    <link href='https://api.mapbox.com/mapbox-gl-js/v0.38.0/mapbox-gl.css' rel='stylesheet' />
    <link href="{% static 'riskdb/css/seg-control.css' %}" rel="stylesheet">
    <script src="{% static 'riskdb/js/d3-legend.min.js' %}"></script>
    <script src="{% static 'riskdb/js/leaflet.js' %}"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v0.38.0/mapbox-gl.js'></script>
    <script src="{% static 'riskdb/js/index.js' %}"></script>
    <script src="{% static 'reporter/js/d3-textwrap.min.js' %}"></script>

    <div id="risk-content">

        <div id="risk-title">
            <h2>Demographic Risk Dashboard</h2>
        </div>
        <div id="search">
            {% include 'homepage/includes/search-snippet.html' %}
            {% block search %}
            {% endblock %}
        </div>
        {% if status != 1 %}
            <hr>
        {% endif %}
        {% if status == 1 %}
        <div id="risk-results">
            <div id="info-results">

                <h3 id="ed-name">{{ cso_ed }}</h3>
                <h4>Population: <span id="pop">{{ age_stats.population }}</span></h4>

                <div id="risks">
                    <div class="risks-row">
                        <div class="risk-cont">
                            <p>Price Risk Profile:</p>
                            <div id="pr-risk-btn" class="risk-btn">{{ pr }}</div>
                        </div>
                        <div class="risk-cont">
                            <p>Age Risk Profile:</p>
                            <div id="age-risk-btn" class="risk-btn">{{ auc }}</div>
                        </div>
                        <div class="risk-cont">
                            <p>Industry Risk Profile:</p>
                            <div id="ind-risk-btn" class="risk-btn">{{ ind }}</div>
                        </div>
                        <div class="risk-cont">
                            <p>Family Risk Profile:</p>
                            <div id="fam-risk-btn" class="risk-btn">{{ fam }}</div>
                        </div>
                    </div>
                    <div class="risks-row">
                        <div class="risk-cont">
                            <p>Professional Risk Profile:</p>
                            <div id="job-risk-btn" class="risk-btn">{{ job }}</div>
                        </div>
                        <div class="risk-cont">
                            <p>Skills Risk Profile:</p>
                            <div id="skills-risk-btn" class="risk-btn">{{ skills }}</div>
                        </div>
                        <div class="risk-cont">
                            <p>Occupancy Risk Profile:</p>
                            <div id="occu-risk-btn" class="risk-btn">{{ occu }}</div>
                        </div>
                        <div class="risk-cont">
                            <p>Ownership Risk Profile:</p>
                            <div id="mort-risk-btn" class="risk-btn">{{ mort }}</div>
                        </div>

                    </div>
                </div>
            </div>
            <hr>
            <div id="charts">
                <div class="chart-row single" id="cpleth">
                    <div id="seg-control-cont">
                        <p>Risk Profile:</p>
                        <div class="segmented-control" id="sc">
                            <input type="radio" name="sc-8" id="sc-8-2-8" checked>
                            <input type="radio" name="sc-8" id="sc-8-2-1">
                            <input type="radio" name="sc-8" id="sc-8-2-2">
                            <input type="radio" name="sc-8" id="sc-8-2-3">
                            <input type="radio" name="sc-8" id="sc-8-2-4">
                            <input type="radio" name="sc-8" id="sc-8-2-5">
                            <input type="radio" name="sc-8" id="sc-8-2-6">
                            <input type="radio" name="sc-8" id="sc-8-2-7">


                            <label for="sc-8-2-8" data-value="Price">Price</label>
                            <label for="sc-8-2-1" data-value="Age">Age</label>
                            <label for="sc-8-2-2" data-value="Industry">Industry</label>
                            <label for="sc-8-2-3" data-value="Family">Family</label>
                            <label for="sc-8-2-4" data-value="Professional">Professional</label>
                            <label for="sc-8-2-5" data-value="Skills">Skills</label>
                            <label for="sc-8-2-6" data-value="Occupancy">Occupancy</label>
                            <label for="sc-8-2-7" data-value="Ownership">Ownership</label>

                        </div>
                    </div>
                    <div id="cp-cont">
                        {% include 'riskdb/includes/choropleth.html' %}
                        {% block choropleth %}
                        {% endblock %}
                    </div>

                </div>
                <hr id="bottomhr">
                <div class="chart-row price">
                    <div id="pricechart" class="chart">
                        <svg id="pchart" xmlns="http://www.w3.org/2000/svg"></svg>
                    </div>
                    <div id="disclaimer">
                    <p>Disclaimer: This prediction is made by a predictive model and assumptions made about properties in the area of question.
                        The accuracy of the model is highly dependent on data quality, which you can read more about <a href="/our-data">here</a>.</p>
                    <p>For a more accurate prediction for a specific property, use our <a href="/hp-predictor">House Price Predictor</a>.</p>
                        </div>
                </div>
                <div class="chart-row">
                    <div class="chart chart-left" id="age-cont">
                        <svg id="chart-age" xmlns="http://www.w3.org/2000/svg"></svg>
                    </div>
                    <div class="chart chart-right" id="ind-cont">
                        <svg id="chart-ind" xmlns="http://www.w3.org/2000/svg"></svg>
                    </div>
                </div>
                <div class="chart-row">
                    <div id="fam-cont" class="chart chart-left">
                        <svg id="chart-fam" xmlns="http://www.w3.org/2000/svg"></svg>
                    </div>
                    <div id="job-cont" class="chart chart-right">
                        <svg id="chart-job" xmlns="http://www.w3.org/2000/svg"></svg>
                    </div>
                </div>
                <div class="chart-row">
                    <div id="skills-cont" class="chart chart-left">
                        <svg id="chart-skills" xmlns="http://www.w3.org/2000/svg"></svg>
                    </div>
                    <div id="occu-cont" class="chart chart-right">
                        <svg id="chart-occu" xmlns="http://www.w3.org/2000/svg"></svg>
                    </div>
                </div>
                <div class="chart-row single">
                    <div id="mort-cont" class="chart">
                        <svg id="chart-mort" xmlns="http://www.w3.org/2000/svg"></svg>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script type="text/javascript">

        var width = 649;
        var height = 500;
        var pop = {{ age_stats.population }};
        var stat = {{ status }};
        var moe = {{ moe }};

        if ( stat === 1 ) {
            {% autoescape off %}
                age_males = {{ age_males }};
                age_na_males = {{ age_na_males }};
                age_females = {{ age_females }};
                age_na_females = {{ age_na_females }};
                fam_profile = {{ fam_profile }};
                fam_natave = {{ fam_natave }};
                ind_profile = {{ ind_profile }};
                ind_natave = {{ ind_natave }};
                job_profile = {{ job_profile }};
                job_natave = {{ job_natave }};
                skills_profile = {{ skills_profile }};
                skills_natave = {{ skills_natave }};
                occu_profile = {{ occu_profile }};
                occu_natave = {{ occu_natave }};
                mort_profile = {{ mort_profile }};
                mort_natave = {{ mort_natave }};
                age_cp_data = {{ age_cp_data }};
                

                ti_data = {{ ti_line }}
                td_data = {{ td_line }}
            {% endautoescape %}

            buttonFormat('#age-risk-btn', '{{ auc }}');
            buttonFormat('#fam-risk-btn', '{{ fam }}');
            buttonFormat('#ind-risk-btn', '{{ ind }}');
            {% if pr != 'Not Applicable' %}
                buttonFormat('#pr-risk-btn', '{{ pr }}');
            {% endif %}
            buttonFormat('#job-risk-btn', '{{ job }}');
            buttonFormat('#skills-risk-btn', '{{ skills }}');
            buttonFormat('#occu-risk-btn', '{{ occu }}');
            buttonFormat('#mort-risk-btn', '{{ mort }}');

            var getAngle = function (d) {
                ang = 180 / Math.PI * (d.startAngle + d.endAngle) / 2 - 90;
                if (ang > 90){
                    ang -= 180
                }
                return ang
            };

            drawXmasChart(age_females, age_males, age_na_females, age_na_males, 'age', 'Age', 'years', 'Population Age Distribution');
            drawPieChart(ind_profile, ind_natave, 'ind', 'Industry', '', 'Workers', 'Industry Profile');
            drawPieChart(fam_profile, fam_natave, 'fam', 'Family Status', '', 'Families', 'Family Profile');
            drawPieChart(job_profile, job_natave, 'job', 'Professional Status', '', 'Population', 'Professional Profile');
            drawPieChart(skills_profile, skills_natave, 'skills', 'Skill Level', '', 'Population', 'Skills Profile');
            drawPieChart(occu_profile, occu_natave, 'occu', 'Occupancy Status', '', 'Families', 'Occupancy Profile');
            drawPieChart(mort_profile, mort_natave, 'mort', 'Ownership Type', '', 'Families', 'Property Ownership Profile');
            {% if pr == 'Not Applicable' %}
                drawPredChart('{{ pr }}');
            {% else %}
                drawPredChart({{ pred_data }}, {{ ti_price }});
            {% endif %}



            $('.xmas-chart').css('width', width);
        }

        function get_index(name){
            switch (name){
                case 'ind':
                    return 7;
                    break;
                case 'fam':
                    return 0;
                    break;
                case 'job':
                    return 7;
                    break;
                case 'skills':
                    return 6;
                    break;
                case 'occu':
                    return 3;
                    break;
                case 'mort':
                    return 6;
                    break;

            }
        }

        function drawPieChart(data, na, chart_name, before_top, after_top, desc, title){
            margin = {top: 40, right: 20, bottom: 30, left: 20};

            ind = get_index(chart_name);
            if (ind > 0){
                for (var i = 0; i < data.length; i++){
                    if (pop_perc(data[i].value, data) < 2 && i != ind) {
                        data[ind].value += data[i].value;
                        data[i].value = 0;
                        data[i].label = '';
                    }
                }
            }

            var container = d3.select("div#" + chart_name + "-cont")
                .style("width", width);

            var svg = d3.select("svg#chart-" + chart_name + "")
                .attr("viewBox", "0 0 " + width + " " + height);

            window.onresize = resized(svg, container);

            var radius = Math.min(width - margin.left - margin.right, height - margin.top - margin.bottom) / 2 + 20;
                g = svg.append("g")
                    .attr("transform", "translate(" + ((width/ 2)) + "," + ((height / 2) + 5) + ")");

            var pie = d3.pie()
                .sort(null)
                .value(function(d) {
                    return d.value;
                });

            var path = d3.arc()
                .outerRadius(radius - 15)
                .innerRadius(0);

              var arc = g.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                  .attr("class", "arc");

              var div = d3.select("body").append("div")
                        .attr("class", "tooltip")
                        .style("opacity", 0);

              arc.append("path")
                  .attr("d", path)
                  .style("fill", function(d){
                      return getfill(chart_name, pop_perc(d.value, data), d.data.label)
                  })
                  .style("opacity", function(d){
                      return getOpac(getfill(chart_name, pop_perc(d.value, data), d.data.label))
                  })
                  .on("mouseover", function(d) {
                    d3.select(this)
                        .style('opacity', 1)
                        .attr('r', 3)
                        .style("fill", "#B32650");
                    div.transition()
                        .duration(200)
                        .style("opacity", .9);

                        div.html(before_top + ": " + d.data.label + " " + after_top + "<br>" +
                            desc + ": " + thousandsDisplay(d.value) +
                            "<br>Percentage: " + pop_perc(d.value, data) + "%" +
                            "<br>National Average: " + pop_perc(get_na(d.data.label, na), na) + "%")
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");

                    })
                    .on("mouseout", function(d) {
                        d3.select(this)
                            .style('opacity', function(d){
                                return getOpac(getfill(chart_name, pop_perc(d.value, data), d.data.label))
                            })
                            .attr('r', 2)
                            .style('fill', function(d){
                                return getfill(chart_name, pop_perc(d.value, data), d.data.label);
                            });
                        div.transition()
                             .duration(500)
                             .style("opacity", 0);
                    });

              var label = d3.arc()
                .outerRadius(radius - 30);

              arc.append("text")
                  .attr("transform", function(d) {
                      ang = 180 / Math.PI * (d.startAngle + d.endAngle) / 2 - 90;
                      if (ang > 90){
                          d.innerRadius = radius - 20;
                      } else {
                            if (d.data.label == 'Agriculture, Forestry and Fishing'){
                                d.innerRadius = radius - 110;
                            } else if (d.data.label == 'Rented from Local Authority'){
                                d.innerRadius = radius - 120;
                            } else if (d.data.label == 'Owner Occupier with Mortgage'){
                                d.innerRadius = radius - 135;
                            } else if (d.data.label == 'Owner Occupier without Mortgage'){
                                d.innerRadius = radius - 20;
                            } else if (d.data.label == 'Rented from Private Landlord'){
                                d.innerRadius = radius - 130;
                            } else if (d.data.label == 'Commerce and Trade'){
                                d.innerRadius = radius - 120;
                            } else {
                                d.innerRadius = radius - 20;
                            }
                      }

                    d.outerRadius = radius - 20;

                    return "translate(" + label.centroid(d) + ") " + "rotate(" + getAngle(d) + ")";
                  })
                  .attr("dy", 0)
                  .attr("dx", 0)
                  .text(function(d) {
                      return d.data.label;
                  })
                  .style('text-anchor', function(d){
                    ang = 180 / Math.PI * (d.startAngle + d.endAngle) / 2 - 90;
                      if (ang > 90){
                          return "start"
                      } else {
                          return "end"
                      }
                });

              var wr = d3.textwrap()
                  .bounds({height: 12, width: (radius - 15)/2})
                  .method('tspans');

              svg.selectAll("text")
                .style("font-size","0.8em")
                .style("font-family", "Raleway")
                .call(wr)
                .style('fill', function(d){
                    return getTextColor(getfill(chart_name, pop_perc(d.value, data), d.data.label));
                });

              svg.append("text")
               .attr("transform", "translate(" + (width / 2) + " , 0)")
               .attr("dy", "1em")
               .style("text-anchor", "middle")
               .text(title)
               .style("font-size","1.6em");

        }

        function pop_perc(pop, data){
            total = 0;
            for (var i = 0; i < data.length; i ++){
                total += data[i]['value']
            }

            return Math.round(pop / total * 10000) / 100;
        }

        function priceButtonFormat(btn, label){
            if (label === 'Very Undervaled'){
                $(btn).css('background-color', 'green')
                      .css('color', 'white')
            } else if (label === 'Very Overvalued'){
                $(btn).css('background-color', 'red')
                      .css('color', 'white')
            } else if (label == 'Overvalued'){
                $(btn).css('background-color', '#FD8D3C')
                      .css('color', 'black')
                      .css('border-color','#ccc')
            } else if (label == 'Undervalued') {
                $(btn).css('background-color', '#6DD07A')
                    .css('color', 'black')
                    .css('border-color', '#ccc')
            } else {
                $(btn).css('background-color', 'white')
                      .css('color', 'black')
                      .css('border-color','#ccc')
            }
        }

        function buttonFormat(btn, label){

            if (label === 'Low Risk' || label == 'Low' || label == 'Undervalued'){
                $(btn).css('background-color', 'green')
                      .css('color', 'white')
            } else if (label === 'High Risk' || label == 'High' || label == 'Overvalued'){
                $(btn).css('background-color', 'red')
                      .css('color', 'white')
            } else if (label === 'Moderate Risk') {
                $(btn).css('background-color', '#ffff99')
                      .css('color', 'black')
                      .css('border-color','#ccc')
            } else if (label == 'Moderate High'){
                $(btn).css('background-color', '#FD8D3C')
                      .css('color', 'black')
                      .css('border-color','#ccc')
            } else if (label == 'Moderate Low'){
                $(btn).css('background-color', '#6DD07A')
                      .css('color', 'black')
                      .css('border-color','#ccc')
            } else {
                $(btn).css('background-color', 'white')
                      .css('color', 'black')
                      .css('border-color','#ccc')
            }
        }

        function get_na(label, data){
            for (var i = 0; i < data.length; i++){
                if (data[i].label == label){
                    return data[i].value;
                }
            }
        }

        function getOpac(fill){
            if (fill == '#05084E'){
                return 0.65
            } else {
                return 1
            }
        }

        function getTextColor(fill){
            if (fill == '#ffff99'){
                return '#05084E'
            } else {
                return 'white'
            }
        }

        function getfill(risk, val, lab){
            if (risk == 'fam'){
                if (lab == 'Retired'){
                    if (val - 6.31 > 4.67){
                        return 'red'
                    } else if (val - 6.28 < -1.837){
                        return 'green'
                    }
                } else if (lab == 'Empty Nest') {
                    if (val - 6.24 > 4.4876){
                        return 'red'
                    } else if (val - 6.24 < -1.377){
                        return 'green'
                    }
                }
                return "#05084E"
            } else if (risk == 'job'){
                if (lab == 'Working'){
                    if (val < 44.03){
                        return 'red'
                    } else if (val > 60.35){
                        return 'green'
                    }
                }
                return "#05084E"

            } else if (risk == 'occu'){
                if (lab == 'Occupied'){
                    if (val < 68.43){
                        return 'red'
                    } else if (val > 92.66){
                        return 'green'
                    }
                }
                return "#05084E"

            } else if (risk == 'mort'){
                if (lab == 'Owner Occupier with Mortgage'){
                    if (val > 43.79){
                        return 'red'
                    } else if (val < 19.4){
                        return 'green'
                    }
                }
                return "#05084E"
            } else if (risk == 'skills'){
                if (val > 38){
                    if (lab === 'Other') {
                        return '#ffff99'
                    } else {
                        return 'red'
                    }
                } else if (val < 23) {
                    return 'green'
                } else {
                    return "#05084E"
                }
            } else {
                if (val > 32){
                    if (lab === 'Other'){
                        return '#ffff99'
                    } else {
                        return 'red'
                    }
                } else if (val < 21.5){
                    return 'green'
                } else {
                    return "#05084E"
                }
            }
        }

        function resized(svg, container){
            var scale = width / container.node().getBoundingClientRect().width;

            // Update SVG height to maintain aspect ratio
            svg.attr("height", height / scale);

            $('.chart-row').css('height', (height / scale ));
            $('.chart').css('height', (height / scale ));
        }

        function resizePriceChart(svg, container){
            var scale = width / container.node().getBoundingClientRect().width;

            // Update SVG height to maintain aspect ratio
            svg.attr("height", height / scale);
            $('#pricechart').css('height', (height / scale ));
            $('.price').css('height', (height / scale ) * 0.8);
        }

        function drawXmasChart(l_data, r_data, ls_data, rs_data, chart_name, before_top, after_top, title) {
            margin = {top: 44, right: 25, bottom: 44, left: 25};

            var container = d3.select("div#" + chart_name + "-cont")
                .style("width",width);

            var svg = d3.select("svg#chart-" + chart_name + "")
                .attr("viewBox", "0 0 " + width + " " + height);

            window.onresize = resized(svg, container);

            var midpoint = (width) / 2;

            var xScale = d3.scaleLinear()
                .domain([0, d3.max(r_data, function(d) {
                    return d.value;
                })])
                .range([0, midpoint - margin.right]);

            var zScale = d3.scaleLinear()
                .domain([d3.max(l_data, function(d) {
                    return d.value;
                }),0])
                .range([margin.left, midpoint]);

            var x = d3.axisBottom()
                      .scale(xScale)
                      .ticks(5)
                      .tickFormat(function (d) {
                           return d + '%'
                       });

            var z = d3.axisBottom()
                      .scale(zScale)
                      .ticks(5)
                      .tickFormat(function (d) {
                           return d + '%'
                       });

            var xs = d3.scaleLinear()
                .rangeRound([0, midpoint - margin.right]);

            var zs = d3.scaleLinear()
                .rangeRound([0, midpoint - margin.left]);

            var y = d3.scaleBand()
                      .range([height - margin.top, margin.bottom])
                      .padding(0.2);

            var rline = d3.line()
                .x(function(d) { return xs(d.value); })
                .y(function(d) { return y(d.label); });

            var lline = d3.line()
                .x(function(d) { return zs(d.value); })
                .y(function(d) { return y(d.label); });

            xs.domain([0, d3.max(r_data, function(d) {
                return d.value;
            })]);

            zs.domain([d3.max(l_data, function(d) {
                return d.value;
            }), 0]);

            y.domain(r_data.map(function(d) {
                return d.label;
            }));

            svg.append("path")
              .datum(rs_data)
              .attr("fill", "none")
              .attr("stroke", "#008000")
              .attr("stroke-linejoin", "round")
              .attr("stroke-linecap", "round")
              .attr("stroke-width", 2)
              .attr("d", rline)
              .attr("transform", "translate(" + midpoint + ", " + y.bandwidth() / 2 + ")");

            svg.append("path")
              .datum(ls_data)
              .attr("fill", "none")
              .attr("data-legend", 'National Average')
              .attr("stroke", "#008000")
              .attr("stroke-linejoin", "round")
              .attr("stroke-linecap", "round")
              .attr("stroke-width", 2)
              .attr("d", lline)
              .attr("transform", "translate(" + margin.left + ", " + y.bandwidth() / 2 + ")");

            var div = d3.select("body").append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0);

            svg.selectAll(".rbar")
                .data(r_data)
              .enter()
                .append("rect")
                .attr("class", "rbar")
                .attr("y", function(d) {
                  return y(d.label);
                })
                .attr("height", y.bandwidth())
                .attr('x', midpoint)
                .attr("width", function(d) {
                  return xScale(d.value);
                })
                .style("fill", "#05084E")
                .style("opacity", .65)
                .on("mouseover", function(d) {
                    d3.select(this)
                        .style('opacity', 1)
                        .attr('r', 3)
                        .style("fill", "#B32650");
                    div.transition()
                        .duration(200)
                        .style("opacity", .9);

                        div.html(before_top + ": " + d.label + " " + after_top +
                            "<br>Percentage: " + d.value + '%' +
                            "<br>National Average: " + get_na(d.label, rs_data) + '%'
                            )
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");

                })
                .on("mouseout", function(d) {
                    d3.select(this)
                        .style('opacity', 0.65)
                        .attr('r', 2)
                        .style("fill", "#05084E");
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            svg.selectAll(".lbar")
                .data(l_data)
              .enter()
                .append("rect")
                .attr("class", "lbar")
                .attr("y", function(d) {
                  return y(d.label);
                })
                .attr("height", y.bandwidth())
                .attr('x', function(d){
                    return zScale(d.value);
                })
                .attr("width", function(d) {
                  return midpoint - zScale(d.value);
                })
                .style("fill", "#B32650")
                .style("opacity", .65)
                .on("mouseover", function(d) {
                    d3.select(this)
                        .style('opacity', 1)
                        .attr('r', 3)
                        .style("fill", "#05084E");
                    div.transition()
                        .duration(200)
                        .style("opacity", .9);

                        div.html(before_top + ": " + d.label + " " + after_top +
                            "<br>Percentage: " + d.value + '%' +
                            "<br>National Average: " + get_na(d.label, ls_data)
                            )
                            .style("left", (d3.event.pageX) - 145 + "px")
                            .style("top", (d3.event.pageY - 28) + "px");

                })
                .on("mouseout", function(d) {
                    d3.select(this)
                        .style('opacity', 0.65)
                        .attr('r', 2)
                        .style("fill", "#B32650");
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            svg.append("g")
               .attr("transform", "translate(" + midpoint + "," + (height - margin.top) + ")")
               .call(x)
            .selectAll("text")
               .attr("y", 6)
               .attr("x", 3)
               .attr("transform", "rotate(45)")
               .style("text-anchor", "start");

            svg.append("g")
               .attr("transform", "translate(0," + (height - margin.top) + ")")
               .call(z)
            .selectAll("text")
               .attr("y", 6)
               .attr("x", 3)
               .attr("transform", "rotate(45)")
               .style("text-anchor", "start");

            // add the y Axis
            svg.append("g")
                .call(d3.axisLeft(y))
                .attr("transform", "translate(" + midpoint + ",0)");

            svg.append("text")
               .attr("transform", "rotate(-90)")
               .attr("y", 0)
               .attr("x", 0 - (height / 2))
               .attr("dy", "1em")
               .style("text-anchor", "middle")
               .text("Female Age Distribution")
               .style("font-size","0.8em");

            svg.append("text")
               .attr("transform", "rotate(-90)")
               .attr("y", width - margin.right + 4)
               .attr("x", 0 - (height / 2))
               .attr("dy", "1em")
               .style("text-anchor", "middle")
               .text("Male Age Distribution")
               .style("font-size","0.8em");

            svg.append("g")
                .attr("class", "grid")
                .attr("transform", "translate(" + (width / 2) + "," + (height - margin.top) + ")")
                .attr('opacity', 0.3)
                .call(x
                  .tickSize(-height + margin.bottom + margin.top)
                  .tickFormat("")
                  .tickSizeOuter(0)
                );

            svg.append("g")
                .attr("class", "grid")
                .attr("transform", "translate(0," + (height - margin.top)  + ")")
                .attr('opacity', 0.3)
                .call(z
                  .tickSize(-height + margin.bottom + margin.top)
                  .tickFormat("")
                  .tickSizeOuter(0)
                );


            var circle = d3.symbol().type(d3.symbolCircle).size(60)();

            var symbolScale =  d3.scaleOrdinal()
              .domain(['National Average'])
              .range([circle]);

            svg.append("g")
              .attr("class", "legendSymbol")
              .attr("transform", "translate(" + (width - 160) + "," + (height - 10) + ")");


            var legendPath = d3.legendSymbol()
              .scale(symbolScale)
              .orient("vertical")
              .labelWrap(100);

            svg.select(".legendSymbol")
              .call(legendPath);

            svg.select('.swatch')
                .style('fill', '#008000')
                .attr("transform", "translate(12, 0)");

            svg.selectAll("text")
                .style("font-size","1.2em")
                .style("font-family", "Raleway")
                .style('font-weight', 'normal');
                //.style('fill', 'white');

            svg.append("text")
                .attr("transform", "translate(" + (width / 2) + " , 0)")
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text(title)
                .style("font-size","1.6em");
        }

        function drawPredChart(data, ti_data){

            margin = {top: 30, right: 70, bottom: 30, left: 60};

            var width = 649,
                height = 500 - 250,
                monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "June",
                    "July", "Aug", "Sept", "Oct", "Nov", "Dec"];

            var container = d3.select("div#pricechart")
                .style("width", width);

            var svg = d3.select("svg#pchart")
                .attr("viewBox", "0 0 " + width + " " + height);

            window.onresize = resizePriceChart(svg, container);

            yMin = 0;

            if (data == 'Not Applicable'){
                yMax = 100000;
            } else {
                yMaxA = d3.max(data, function (d) {
                    return d[1] + moe
                });

                yMaxB = Math.round(ti_data[0], 0);

                if (yMaxA > yMaxB){
                    yMax = yMaxA
                } else {
                    yMax = yMaxB
                }
            }

            deltaY = yMax * 0.1;

            var yScale = d3.scaleLinear()
                .domain([0, yMax + deltaY])
                .range([height - margin.bottom, margin.top]);

            var yAxis = d3.axisLeft()
                .scale(yScale)
                .ticks(5)
                .tickFormat(function (d) {
                    var val;
                    if (d >= 1000000) {
                        val = d / 1000000 + ' M'
                    } else if (d == 0) {
                        val = 0
                    } else if (d >= 1000) {
                        val = d / 1000 + ' k'
                    } else {
                        val = d
                    }
                    return '€ ' + val
                })
                .tickSizeOuter(0);

            if (data == 'Not Applicable'){
                xMin = 1284940800000;
                xMax = 1502668800000;
            }
            else{
                xMin = d3.min(data, function (d) {
                    return d[0];
                });
                xMax = d3.max(data, function (d) {
                    return d[0];
                });
            }

            deltaX = (xMax - xMin) * 0.05;

            var xScale = d3.scaleLinear()
                .domain([xMin - deltaX, xMax + deltaX])
                .range([margin.left, width - margin.right]);

            var xAxis = d3.axisBottom()
                .scale(xScale)
                .tickFormat(function (d) {
                    var dot = new Date(d);
                    return monthNames[dot.getUTCMonth()] + '-' +
                        String(dot.getUTCFullYear()).slice(2);
                });

            if (data == 'Not Applicable'){
                svg.append("text")
                   .attr("transform", "translate(" + (width / 2) + " , " + (height/ 2 - margin.bottom/ 2) + ")")
                   .attr("dy", "1em")
                   .style("text-anchor", "middle")
                   .text("Not Enough Data to Make Prediction")
                   .style("font-size","0.9em");
            } else {
                ti = [[xMin - deltaX, yMaxB], [xMax + deltaX, yMaxB]];

                div = d3.select("body").append("div")
                        .attr("class", "tooltip")
                        .style("opacity", 0);

                svg.append("defs").append("clipPath")
                    .attr("id", "clip")
                  .append("rect")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                    .attr("width", width - margin.left - margin.right)
                    .attr("height", height - margin.bottom - margin.top);

                var line = d3.line()
                    .curve(d3.curveBasis)
                    .x(function(d) { return xScale(d[0]); })
                    .y(function(d) { return yScale(d[1]); });

                linedata = [];
                moe_high_data = [];
                moe_low_data = [];
                for (var i = 0; i < data.length; i ++){
                    if (i == 0){
                        linedata.push([data[i][0] + deltaX, data[i][1]]);
                        linedata.push([data[i][0], data[i][1]]);
                        moe_high_data.push([data[i][0] + deltaX, data[i][1] + moe]);
                        moe_high_data.push([data[i][0], data[i][1] + moe]);
                        moe_low_data.push([data[i][0] + deltaX, data[i][1] - moe]);
                        moe_low_data.push([data[i][0], data[i][1] - moe]);
                    } else if (i == data.length - 1){
                        linedata.push([data[i][0], data[i][1]]);
                        linedata.push([data[i][0] - deltaX, data[i][1]]);
                        moe_high_data.push([data[i][0], data[i][1] + moe]);
                        moe_high_data.push([data[i][0] - deltaX, data[i][1] + moe]);
                        moe_low_data.push([data[i][0], data[i][1] - moe]);
                        moe_low_data.push([data[i][0] - deltaX, data[i][1] - moe]);
                    } else {
                        linedata.push([data[i][0], data[i][1]]);
                        moe_high_data.push([data[i][0], data[i][1] + moe]);
                        moe_low_data.push([data[i][0], data[i][1] - moe]);
                    }
                }

                svg.append("g")
                    .attr("clip-path", "url(#clip)")
                    .append("path")
                  .datum(moe_high_data)
                  .attr('class', 'line')
                  .attr("fill", "none")
                  .attr("stroke", "#99d6ff")
                  .attr("stroke-linejoin", "round")
                  .attr("stroke-linecap", "round")
                  .attr("stroke-width", 2)
                  .attr("d", line);

                svg.append("g")
                    .attr("clip-path", "url(#clip)")
                    .append("path")
                  .datum(moe_low_data)
                  .attr('class', 'line')
                  .attr("fill", "none")
                  .attr("stroke", "#99d6ff")
                  .attr("stroke-linejoin", "round")
                  .attr("stroke-linecap", "round")
                  .attr("stroke-width", 2)
                  .attr("d", line);

                var indexies = d3.range(moe_high_data.length);

                var area = d3.area()

                      .x( function(d) { return xScale(moe_high_data[d][0]) } )
                      .y0( function(d) { return yScale(moe_low_data[d][1]) })
                      .y1( function(d) { return yScale(moe_high_data[d][1]) } )
                    .curve(d3.curveBasis);

                svg.append('path')
                  .data([indexies])
                  .attr('class', 'area')
                  .attr('d', area);

                svg.select('.area')
                    .style("fill", "#99d6ff")
                    .style('opacity', 0.3)
                    .style('z-index', 1);

                svg.append("g")
                    .attr("clip-path", "url(#clip)")
                    .append("path")
                  .datum(ti)
                  .attr('class', 'line')
                  .attr("fill", "none")
                  .attr("stroke", "#a6a6a6")
                  .attr("stroke-linejoin", "round")
                  .attr("stroke-linecap", "round")
                  .attr("stroke-width", 2)
                  .attr("d", line);

                svg.append("g")
                    .attr("clip-path", "url(#clip)")
                    .append("path")
                  .datum(linedata)
                  .attr('class', 'line')
                  .attr("fill", "none")
                  .attr("stroke", "#B32650")
                  .attr("stroke-linejoin", "round")
                  .attr("stroke-linecap", "round")
                  .attr("stroke-width", 2)
                  .attr("d", line);



                svg.selectAll("circle")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("cx", function (d) {
                        return xScale(d[0]);
                    })
                    .attr("cy", function (d) {
                        return yScale(d[1]);
                    })
                    .attr("r", 3)
                    .style("fill", function(d) {
                          return '#05084E';
                    })
                    .style("opacity", .65)
                    .on("mouseover", function(d) {
                        d3.select(this)
                            .style('opacity', 1);

                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        t = new Date(d[0]);

                        tooltip_label = monthNames[t.getUTCMonth()] + "-" + String(t.getUTCFullYear());

                        div.html(tooltip_label + "<br>Predicted Price: € " + thousandsDisplay(d[1]))
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");

                        })
                    .on("mouseout", function(d) {
                        d3.select(this)
                            .style('opacity', 0.65)
                            .attr('r', 3);
                        div.transition()
                             .duration(500)
                             .style("opacity", 0);
                    });

                var symbolScale =  d3.scaleOrdinal()
                  .domain(['Moving Average', 'Baseline Prediction', 'Margin of Error'])
                  .range(['#B32650', '#a6a6a6', '#99d6ff']);

                svg.append("g")
                  .attr("class", "legendOrdinal")
                  .attr("transform", "translate(" + (width - 160) + "," + (height - 70) + ")");

                var legendOrdinal = d3.legendColor()
                  .shape("path", d3.symbol().type(d3.symbolCircle).size(20)())
                  .scale(symbolScale)
                  .orient("vertical")
                  .shapePadding(0);

                svg.select(".legendOrdinal")
                  .call(legendOrdinal);

                svg.selectAll('.swatch')
                    .attr("transform", "translate(5, 2)");

                svg.selectAll(".label")
                    .style("font-size","0.6em")
                    .style('font-weight', 'normal');
            }

            // Add Title
            svg.append("text")
               .attr("transform", "translate(" + (width / 2) + " , 0)")
               .attr("dy", "1em")
               .style("text-anchor", "middle")
               .text("Price Prediction Profile")
               .style("font-size","1.2em");

            // Add and format X-axis
            svg.append("g")
                .attr("class", "l x axis")
                .attr("transform", "translate(0," + (height - margin.bottom) + ")")
                .call(xAxis)
            .selectAll("text")
                .attr("y", 6)
                .attr("x", -3)
                .style("font-size","0.8em")
                .attr("transform", "rotate(45)")
                .style("text-anchor", "start")
                .style("font-family", "Raleway");

            // Add and format X-axis label
            svg.append("text")
               .attr("transform", "translate(" + (width - margin.right/2) + " ," + (height) + ")")
               .style("text-anchor", "middle")
               .text("Date of Sale")
               .style("font-size","0.8em");

            // Add and format Y-axis
            svg.append("g")
                .attr("class", "l y axis")
                .attr("transform", "translate(" + margin.left + ",0)")
                .call(yAxis)
            .selectAll("text")
                .style("font-size","0.8em")
                .style("font-family", "Raleway");

            // Add and format Y-axis label
            svg.append("text")
                .attr('class', 'y-axis-label')
                .attr("transform", "rotate(-90)")
                .attr("y", 0)
                .attr("x",0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Predicted Price")
                .style("font-size","0.8em");
        }


    </script>

{% endblock %}